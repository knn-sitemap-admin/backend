<div class="auth">
    <div class="auth__panel">
        <div class="auth__head">
            <div class="auth__title">BOOTSTRAP ADMIN</div>
            <div class="auth__sub">최초 1회 관리자 계정 생성</div>
        </div>

        <form class="form" id="bootstrap-form">
            <label class="field">
                <div class="field__label">Email</div>
                <input class="input" type="email" name="email" placeholder="admin@company.com" autocomplete="username" required />
            </label>

            <label class="field">
                <div class="field__label">Password</div>
                <input class="input" type="password" name="password" placeholder="••••••••" autocomplete="new-password" required />
            </label>

            <label class="field">
                <div class="field__label">Bootstrap Token</div>
                <input class="input" type="text" name="token" placeholder="x-bootstrap-token" required />
                <div class="field__hint">헤더 <span class="kbd">x-bootstrap-token</span> 으로 전송됩니다.</div>
            </label>

            <div class="row">
                <button class="btn btn--primary" type="submit">생성</button>
                <a class="btn btn--ghost" href="/owner/login">로그인으로</a>
            </div>

            <div class="hint">
                이미 관리자/계정1이 있으면 이 페이지는 차단되고 로그인으로 이동해야 정상입니다.
            </div>
        </form>

        <div class="toast" id="toast" aria-hidden="true"></div>
    </div>
</div>

<script>
    (function () {
        const form = document.getElementById('bootstrap-form');
        const toast = document.getElementById('toast');

        function showToast(msg) {
            toast.textContent = msg;
            toast.setAttribute('aria-hidden', 'false');
            toast.classList.add('is-open');
            setTimeout(() => toast.classList.remove('is-open'), 2400);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const email = String(fd.get('email') || '');
            const password = String(fd.get('password') || '');
            const token = String(fd.get('token') || '');

            const res = await fetch('/auth/bootstrap-admin', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'x-bootstrap-token': token,
                },
                body: JSON.stringify({ email, password }),
            });

            const json = await res.json().catch(() => ({}));
            if (!res.ok) {
                const msg = (json && json.messages && json.messages[0]) ? json.messages[0] : '실패';
                showToast(msg);
                return;
            }

            showToast('관리자 생성 완료. 로그인 페이지로 이동합니다.');
            setTimeout(() => (location.href = '/owner/login'), 900);
        });
    })();
</script>
