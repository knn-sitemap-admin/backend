<div class="owner-contracts-page">
    <div class="oc-page-header">
        <h1>계약 현황</h1>
        <div class="oc-page-subtitle">
            계약 리스트 / 필터 / 정렬 / 페이징
        </div>
    </div>

    <%
    // period === 'custom' 이면 직접입력 모드, 나머지는 빠른선택
    const periodMode = filter.period === 'custom' ? 'custom' : 'preset';
    %>

    <form method="get" class="oc-filter-form">
        <!-- 1줄 : 상태 / 담당 팀 / 담당자 / 고객명 / 기간 -->
        <div class="oc-row">
            <div class="oc-field">
                <label for="status">상태</label>
                <select name="status" id="status">
                    <option value="all"      <%= filter.status === 'all' ? 'selected' : '' %>>전체</option>
                    <option value="ongoing"  <%= filter.status === 'ongoing' ? 'selected' : '' %>>진행중</option>
                    <option value="done"     <%= filter.status === 'done' ? 'selected' : '' %>>완료</option>
                    <option value="canceled" <%= filter.status === 'canceled' ? 'selected' : '' %>>취소</option>
                </select>
            </div>

            <div class="oc-field">
                <label for="qTeam">담당 팀</label>
                <select name="qTeam" id="qTeam">
                    <option value="">전체 팀</option>
                    <% if (Array.isArray(teams)) { %>
                        <% teams.forEach(function(t) { %>
                            <option value="<%= t.name %>" <%= filter.qTeam === t.name ? 'selected' : '' %>>
                                <%= t.name %>
                            </option>
                        <% }) %>
                    <% } %>
                </select>
            </div>

            <div class="oc-field">
                <label for="qSalesperson">담당자</label>
                <input
                        type="text"
                        id="qSalesperson"
                        name="qSalesperson"
                        value="<%= filter.qSalesperson || '' %>"
                        placeholder="담당자 이름"
                />
            </div>

            <div class="oc-field">
                <label for="qCustomer">고객명</label>
                <input
                        type="text"
                        id="qCustomer"
                        name="qCustomer"
                        value="<%= filter.qCustomer || '' %>"
                        placeholder="고객명"
                />
            </div>

            <div class="oc-field oc-field-period">
                <div class="oc-period-top">
                    <span class="oc-period-label">기간</span>
                    <label class="oc-radio-inline">
                        <input
                                type="radio"
                                name="periodMode"
                                value="preset"
                                <%= periodMode === 'preset' ? 'checked' : '' %>
                        />
                        빠른선택
                    </label>
                    <label class="oc-radio-inline">
                        <input
                                type="radio"
                                name="periodMode"
                                value="custom"
                                <%= periodMode === 'custom' ? 'checked' : '' %>
                        />
                        직접입력
                    </label>
                </div>

                <div class="oc-period-preset">
                    <select name="periodPreset" id="periodPreset">
                        <option value="today"   <%= filter.period === 'today' ? 'selected' : '' %>>오늘</option>
                        <option value="week"    <%= filter.period === 'week' ? 'selected' : '' %>>1주일</option>
                        <option value="month"   <%= filter.period === 'month' ? 'selected' : '' %>>1개월</option>
                        <option value="quarter" <%= filter.period === 'quarter' ? 'selected' : '' %>>3개월</option>
                        <option value="half"    <%= filter.period === 'half' ? 'selected' : '' %>>6개월</option>
                        <option value="year"    <%= filter.period === 'year' ? 'selected' : '' %>>1년</option>
                    </select>
                </div>

                <div class="oc-period-custom">
                    <input
                            type="date"
                            name="from"
                            value="<%= filter.from || '' %>"
                    />
                    <span>~</span>
                    <input
                            type="date"
                            name="to"
                            value="<%= filter.to || '' %>"
                    />
                </div>

                <!-- 서버에서 쓰는 실제 period 값 -->
                <input type="hidden" name="period" value="<%= filter.period %>" />
            </div>
        </div>

        <!-- 2줄 : 계약번호 범위 / 최종합계 범위 / 정렬 + 페이지 + 조회/초기화 -->
        <div class="oc-row">
            <div class="oc-field">
                <label>계약번호 범위</label>
                <div class="oc-inline">
                    <input
                            type="number"
                            name="idFrom"
                            value="<%= typeof filter.idFrom === 'number' ? filter.idFrom : '' %>"
                            placeholder="from"
                    />
                    <span>~</span>
                    <input
                            type="number"
                            name="idTo"
                            value="<%= typeof filter.idTo === 'number' ? filter.idTo : '' %>"
                            placeholder="to"
                    />
                </div>
            </div>

            <div class="oc-field">
                <label>최종합계 범위</label>
                <div class="oc-inline">
                    <input
                            type="number"
                            name="grandMin"
                            value="<%= typeof filter.grandMin === 'number' ? filter.grandMin : '' %>"
                            placeholder="min"
                    />
                    <span>~</span>
                    <input
                            type="number"
                            name="grandMax"
                            value="<%= typeof filter.grandMax === 'number' ? filter.grandMax : '' %>"
                            placeholder="max"
                    />
                </div>
            </div>

            <div class="siba">
                <div class="oc-field oc-field-sort">
                    <label>정렬 / 페이지</label>
                    <div class="oc-inline oc-inline-right">
                        <select name="sort" id="sort">
                            <option value="contractDate" <%= filter.sort === 'contractDate' ? 'selected' : '' %>>
                                계약일
                            </option>
                            <option value="grandTotal" <%= filter.sort === 'grandTotal' ? 'selected' : '' %>>
                                최종 합계
                            </option>
                            <option value="createdAt" <%= filter.sort === 'createdAt' ? 'selected' : '' %>>
                                생성일
                            </option>
                        </select>
                        <select name="dir">
                            <option value="desc" <%= (!filter.dir || filter.dir === 'desc') ? 'selected' : '' %>>
                                내림차순
                            </option>
                            <option value="asc"  <%= filter.dir === 'asc' ? 'selected' : '' %>>
                                오름차순
                            </option>
                        </select>
                        <select name="pageSize" id="pageSize">
                            <option value="20"  <%= filter.pageSize === 20 ? 'selected' : '' %>>20</option>
                            <option value="50"  <%= filter.pageSize === 50 ? 'selected' : '' %>>50</option>
                            <option value="100" <%= filter.pageSize === 100 ? 'selected' : '' %>>100</option>
                        </select>
                        <button type="submit">조회</button>
                        <a href="/owner/contracts" class="oc-btn-reset">초기화</a>
                    </div>
                </div>
            </div>

        </div>
    </form>

    <div class="oc-table-wrapper">
        <table class="oc-data-table">
            <thead>
            <tr>
                <th>계약번호</th>
                <th>상태</th>
                <th>계약일</th>
                <th>고객명</th>
                <th>담당자</th>
                <th>담당 팀</th>
                <th>최종합계</th>
                <th>중개보수합</th>
                <th>리베이트합</th>
                <th>지원금</th>
                <th>전화번호</th>
            </tr>
            </thead>
            <tbody>
            <% if (result.items.length === 0) { %>
                <tr>
                    <td colspan="11" class="oc-empty-cell">
                        검색 조건에 해당하는 계약이 없습니다.
                    </td>
                </tr>
            <% } else { %>
                <% result.items.forEach(function(item) { %>
                    <tr>
                        <td><%= item.id %></td>
                        <td><%= item.statusLabel %></td>
                        <td><%= item.contractDate %></td>
                        <td><%= item.customerName || '' %></td>
                        <td><%= item.salespersonName || '' %></td>
                        <td><%= item.teamName || '' %></td>
                        <td class="oc-num"><%= item.grandTotal.toLocaleString('ko-KR') %></td>
                        <td class="oc-num"><%= item.brokerageTotal.toLocaleString('ko-KR') %></td>
                        <td class="oc-num"><%= item.rebateTotal.toLocaleString('ko-KR') %></td>
                        <td class="oc-num"><%= item.supportAmount.toLocaleString('ko-KR') %></td>
                        <td><%= item.customerPhone || '' %></td>
                    </tr>
                <% }) %>
            <% } %>
            </tbody>
        </table>
    </div>

    <%
    const totalPages = Math.max(1, Math.ceil(result.totalCount / result.pageSize));
    const currentPage = result.page;

    const qs = function(page) {
        const params = new URLSearchParams();
        params.set('status', filter.status);
        if (filter.qTeam) params.set('qTeam', filter.qTeam);
        if (filter.qSalesperson) params.set('qSalesperson', filter.qSalesperson);
        if (filter.qCustomer) params.set('qCustomer', filter.qCustomer);

        if (typeof filter.idFrom === 'number') params.set('idFrom', String(filter.idFrom));
        if (typeof filter.idTo === 'number') params.set('idTo', String(filter.idTo));
        if (typeof filter.grandMin === 'number') params.set('grandMin', String(filter.grandMin));
        if (typeof filter.grandMax === 'number') params.set('grandMax', String(filter.grandMax));

        params.set('period', filter.period);
        if (filter.from) params.set('from', filter.from);
        if (filter.to) params.set('to', filter.to);

        params.set('sort', filter.sort);
        params.set('dir', filter.dir || 'desc');
        params.set('pageSize', String(filter.pageSize));
        params.set('page', String(page));

        return '/owner/contracts?' + params.toString();
    };
    %>

    <div class="oc-pagination">
        <div class="oc-pagination-info">
            총 <%= result.totalCount %>건 /
            <%= currentPage %> / <%= totalPages %> 페이지
        </div>

        <div class="oc-pagination-links">
            <% if (currentPage > 1) { %>
                <a href="<%= qs(1) %>">&laquo; 처음</a>
                <a href="<%= qs(currentPage - 1) %>">&lsaquo; 이전</a>
            <% } %>

            <% for (let p = 1; p <= totalPages; p++) { %>
                <% if (p === currentPage) { %>
                    <span class="current"><%= p %></span>
                <% } else if (p === 1 || p === totalPages || Math.abs(p - currentPage) <= 2) { %>
                    <a href="<%= qs(p) %>"><%= p %></a>
                <% } else if (p === currentPage - 3 || p === currentPage + 3) { %>
                    <span class="dots">...</span>
                <% } %>
            <% } %>

            <% if (currentPage < totalPages) { %>
                <a href="<%= qs(currentPage + 1) %>">다음 &rsaquo;</a>
                <a href="<%= qs(totalPages) %>">마지막 &raquo;</a>
            <% } %>
        </div>
    </div>
</div>

<style>
    .siba{
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    .owner-contracts-page {
        font-size: 13px;
    }

    .oc-page-header {
        margin-bottom: 16px;
    }

    .oc-page-header h1 {
        margin: 0;
        font-size: 24px;
    }

    .oc-page-subtitle {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
    }

    /* 필터 상단 2줄 레이아웃 */
    .oc-filter-form {
        margin-bottom: 12px;
    }

    .oc-row {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 8px;
    }

    .oc-field {
        display: flex;
        flex-direction: column;
        flex: 1 1 0;
        min-width: 0;
    }

    .oc-field-period {
        flex: 1.8;
    }

    .oc-field-sort {
        justify-content: flex-end;
    }

    .oc-field label {
        font-size: 12px;
        margin-bottom: 4px;
        color: #555;
    }

    .oc-field input,
    .oc-field select {
        font-size: 13px;
        padding: 4px 6px;
        border: 1px solid #ccc;
        border-radius: 2px;
        box-sizing: border-box;
    }

    .oc-inline {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .oc-inline-right {

    }

    /* 기간 위/아래 정렬 */
    .oc-period-top {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }

    .oc-period-label {
        font-size: 12px;
        color: #555;
    }

    .oc-radio-inline {
        display: flex;
        align-items: center;
        gap: 2px;
        font-size: 12px;
    }

    .oc-period-preset,
    .oc-period-custom {
        margin-bottom: 2px;
    }

    .oc-btn-reset {
        display: inline-block;
        padding: 4px 10px;
        font-size: 13px;
        text-decoration: none;
        border: 1px solid #ccc;
        border-radius: 2px;
        background: #f8f8f8;
        color: #333;
    }

    /* 테이블 */
    .oc-table-wrapper {
        background: #ffffff;
        border: 1px solid #dcdcdc;
        overflow-x: auto;
    }

    .oc-data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .oc-data-table thead {
        background: #f0f0f0;
    }

    .oc-data-table th,
    .oc-data-table td {
        padding: 6px 8px;
        border: 1px solid #e0e0e0;
        white-space: nowrap;
    }

    .oc-data-table th {
        text-align: left;
    }

    .oc-data-table td.oc-num {
        text-align: right;
    }

    .oc-empty-cell {
        text-align: center;
        padding: 12px;
    }

    /* 페이징 */
    .oc-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 12px;
    }

    .oc-pagination-links a,
    .oc-pagination-links span {
        margin: 0 2px;
        text-decoration: none;
    }

    .oc-pagination-links .current {
        font-weight: bold;
        padding: 2px 6px;
        border: 1px solid #999;
    }

    .oc-pagination-links .dots {
        padding: 0 4px;
        color: #999;
    }
</style>
